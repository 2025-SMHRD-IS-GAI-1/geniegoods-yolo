name: NCP Private Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/geniegoods-yolo:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to NCP Private Server
        uses: appleboy/ssh-action@master
        with:
          # 1. 공인 IP 서버 (Bastion) 정보
          proxy_host: ${{ secrets.NCP_PUBLIC_IP }}
          proxy_username: ${{ secrets.NCP_USERNAME }}
          proxy_key: ${{ secrets.NCP_SSH_PRIVATE_KEY }}

          # 2. 사설 서버 (YOLO 서버) 정보
          host: ${{ secrets.NCP_PRIVATE_IP }} # 10.250.x.x 등의 내부 IP
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_PRIVATE_KEY }} # 같은 키를 쓴다면 동일하게 입력

          script: |
            cd /opt/geniegoods
            
            # Docker Hub 아이디를 환경 변수로 선언 (docker-compose.yml에서 사용)
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            # 최신 이미지 받아오기
            docker-compose pull
            
            # 서비스 재시작
            docker-compose up -d
            
            # 불필요한 구형 이미지 삭제
            docker image prune -f